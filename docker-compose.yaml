version: "3.8"
services:
  # Grafana configuration
  grafana:
    image: grafana/grafana-oss
    environment:
      - SERVICE_FQDN_GRAFANA_3000
      - "GF_SECURITY_ADMIN_PASSWORD=${SERVICE_PASSWORD_GRAFANA}"
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=postgresql
      - "GF_DATABASE_USER=${SERVICE_USER_POSTGRES}"
      - "GF_DATABASE_PASSWORD=${SERVICE_PASSWORD_POSTGRES}"
      - "GF_DATABASE_NAME=${POSTGRES_DB:-grafana}"
    volumes:
      - "grafana-data:/var/lib/grafana"
    healthcheck:
      test:
        - CMD
        - curl
        - "-f"
        - "http://127.0.0.1:3000/api/health"
      interval: 5s
      timeout: 20s
      retries: 10
    depends_on:
      - postgresql

  # PostgreSQL configuration
  postgresql:
    image: "postgres:16-alpine"
    volumes:
      - "postgresql-data:/var/lib/postgresql/data"
    environment:
      - "POSTGRES_USER=${SERVICE_USER_POSTGRES}"
      - "POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}"
      - "POSTGRES_DB=${POSTGRES_DB:-grafana}"
    healthcheck:
      test:
        - CMD-SHELL
        - "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"
      interval: 5s
      timeout: 20s
      retries: 10

  # GCS Credentials Setup
  # This service runs once to write the GCS service account JSON from an environment
  # variable to a file in a shared volume, so Loki and Tempo can authenticate.
  gcs-credentials-setup:
    image: alpine:latest
    command: >
      sh -c "echo \"$$GCS_SERVICE_ACCOUNT\" > /credentials/gcs.json"
    environment:
      - "GCS_SERVICE_ACCOUNT=${GCS_SERVICE_ACCOUNT}"
    volumes:
      - "credentials:/credentials"

  # Loki configuration
  loki:
    image: "grafana/loki:latest"
    command:
      - "-config.file=/etc/grafana/loki/loki-config.yaml"
      - "-config.expand-env=true"
    environment:
      - "GCS_BUCKET_NAME=${GCS_BUCKET_NAME}"
      - "GOOGLE_APPLICATION_CREDENTIALS=/credentials/gcs.json"
    volumes:
      - "./config/loki:/etc/grafana/loki"
      - "loki-data:/loki"
      - "credentials:/credentials:ro"
    depends_on:
      gcs-credentials-setup:
        condition: service_completed_successfully
    healthcheck:
      test:
        - CMD-SHELL
        - "wget --tries=1 --spider http://localhost:3100/ready || exit 1"
      interval: 10s
      timeout: 5s
      retries: 5

  # Tempo configuration
  tempo:
    image: "grafana/tempo:latest"
    command:
      - "-config.file=/etc/tempo/tempo.yaml"
      - "-config.expand-env=true"
    environment:
      - "GCS_BUCKET_NAME=${GCS_BUCKET_NAME}"
      - "GOOGLE_APPLICATION_CREDENTIALS=/credentials/gcs.json"
    volumes:
      - "./config/tempo:/etc/tempo"
      - "tempo-data:/var/tempo"
      - "credentials:/credentials:ro"
    depends_on:
      gcs-credentials-setup:
        condition: service_completed_successfully

  # Grafana Alloy configuration
  alloy:
    image: "grafana/alloy:latest"
    command:
      - run
      - /etc/alloy/config.alloy
    environment:
      - SERVICE_FQDN_ALLOY_4318
    labels:
      - traefik.http.middlewares.alloy-auth.basicauth.users=${ALLOY_BASIC_AUTH}
      - traefik.http.routers.https-alloy-4318.middlewares=alloy-auth
    volumes:
      - "./config/alloy:/etc/alloy"
    depends_on:
      - loki
      - tempo

  # Prometheus configuration
  prometheus:
    image: "prom/prometheus:latest"
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - "./config/prometheus:/etc/prometheus:ro"
      - "prometheus-data:/prometheus"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-remote-write-receiver" # Enable prometheus receiver for remote write
    healthcheck:
      test:
        - CMD
        - wget
        - "--no-verbose"
        - "--tries=1"
        - "--spider"
        - "http://localhost:9090/-/healthy"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
volumes:
  grafana-data:
  postgresql-data:
  loki-data:
  tempo-data:
  prometheus-data:
  credentials:
